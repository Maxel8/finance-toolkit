name: Update Release Status in Wiki (Home.md)

on:
  schedule:
    - cron: '0 7,17 * * *' # GitHub Actions benutzt UTC; das entspricht 08:00/18:00 Europe/Berlin (achte auf DST)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-wiki:
    runs-on: ubuntu-latest

    steps:
      - name: Generate release status markdown
        id: gen
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');

            // Releases + Milestones (paginiert)
            const releases = await github.paginate(github.rest.repos.listReleases, { owner, repo, per_page: 100 });
            const milestones = await github.paginate(github.rest.issues.listMilestones, { owner, repo, state: 'all', per_page: 100 });

            const stable = releases.find(r => !r.prerelease);
            const beta = releases.find(r => r.prerelease);

            function findMilestoneForTag(tag) {
              if (!tag) return null;
              const normalized = tag.replace(/^v/i, '');
              return milestones.find(m =>
                m.title === tag ||
                m.title === normalized ||
                m.title.includes(tag) ||
                m.title.includes(normalized)
              ) || null;
            }

            async function getStatus(milestone) {
              if (!milestone) return '✅';
              const allIssues = await github.paginate(github.rest.issues.listForRepo, {
                owner, repo, state: 'open', milestone: milestone.number, per_page: 100
              });
              const issues = allIssues.filter(i => !i.pull_request);
              const hasBug = issues.some(issue =>
                (issue.labels || []).some(l => (typeof l === 'string' ? l === 'bug' : (l && l.name === 'bug')))
              );
              if (hasBug) return '❌';
              return issues.length > 0 ? '⚠️' : '✅';
            }

            const stableMilestone = findMilestoneForTag(stable?.tag_name);
            const betaMilestone = findMilestoneForTag(beta?.tag_name);

            const stableStatus = await getStatus(stableMilestone);
            const betaStatus = await getStatus(betaMilestone);

            const now = new Date().toLocaleString('de-DE', { timeZone: 'Europe/Berlin' });
            const table = `### Release Status

| Stable | Beta |
|-------:|:----|
| ${stable?.tag_name ?? '-'} | ${beta?.tag_name ?? '-'} |
| ${stableStatus} | ${betaStatus} |

*Zuletzt aktualisiert: ${now}*`;

            const out = 'status_snippet.md';
            fs.writeFileSync(out, table, { encoding: 'utf8' });
            core.setOutput('snippet', out);
            core.setOutput('timestamp', now);
            return { snippet: out, now };

      - name: Clone Wiki repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          REPO="${{ github.repository }}"
          # Klone das Wiki-Repo
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.wiki.git wiki
          ls -la wiki

      - name: Inject snippet into Wiki Home.md (or create)
        env:
          SNIPPET: ${{ steps.gen.outputs.snippet }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          SNIPPET_FILE="${SNIPPET:-status_snippet.md}"
          WIKI_DIR=wiki
          WIKI_HOME="$WIKI_DIR/Home.md"

          # Ensure snippet exists
          if [ ! -f "$SNIPPET_FILE" ]; then
            echo "Snippet file not found: $SNIPPET_FILE"
            exit 1
          fi

          # Prepare the replacement block markers
          START="<!-- RELEASE_STATUS_START -->"
          END="<!-- RELEASE_STATUS_END -->"

          # Read snippet into a variable, escape for sed use (use awk for safe insertion)
          SNIPPET_CONTENT=$(awk '{print}' "$SNIPPET_FILE")

          # If Home.md doesn't exist, create it and add the block
          if [ ! -f "$WIKI_HOME" ]; then
            echo "Home.md not found in wiki — creating new Home.md with Release Status block."
            {
              echo "# Home"
              echo ""
              echo "$START"
              cat "$SNIPPET_FILE"
              echo "$END"
            } > "$WIKI_HOME"
          else
            # If markers exist, replace the section between them.
            if grep -q "$START" "$WIKI_HOME" && grep -q "$END" "$WIKI_HOME"; then
              # Use awk to replace between markers (preserve other content)
              awk -v start="$START" -v end="$END" -v file="$SNIPPET_FILE" '
                BEGIN {inblock=0}
                {
                  if ($0 ~ start) {
                    print $0
                    # print snippet
                    while ((getline line < file) > 0) print line
                    inblock=1
                    next
                  }
                  if ($0 ~ end) {
                    print $0
                    inblock=0
                    next
                  }
                  if (!inblock) print $0
                }
              ' "$WIKI_HOME" > "$WIKI_HOME.tmp" && mv "$WIKI_HOME.tmp" "$WIKI_HOME"
            else
              # Append the block at the end
              {
                echo ""
                echo "$START"
                cat "$SNIPPET_FILE"
                echo "$END"
              } >> "$WIKI_HOME"
            fi
          fi

          # Commit only if changes exist
          cd "$WIKI_DIR"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add Home.md

          if git diff --cached --quiet; then
            echo "No changes to commit to wiki Home.md."
          else
            git commit -m "ci: update release status in Home.md"
            git push origin HEAD
            echo "Wiki Home.md updated and pushed."
          fi
